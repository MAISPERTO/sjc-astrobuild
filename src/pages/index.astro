---
// src/pages/index.astro (VERS√ÉO FINAL COM SDK E TRATAMENTO DE ERROS)
import Layout from '../layouts/Layout.astro'; 
import * as api from '../lib/api'; // Importa√ß√£o padr√£o para estabilidade

export const prerender = false; // Necess√°rio para a arquitetura SSR

// --- DEFINI√á√ïES DE AMBIENTE ---
const CITY_NAME = import.meta.env.PUBLIC_CITY_NAME || 'S√£o Jos√© dos Campos';
const SITE_DOMAIN = import.meta.env.SITE || 'MAISPERTO'; 


// --- BUSCAS DE DADOS (USANDO SDK VIA API.FUNCAO) ---

let bairrosDirectus = [];
let bairroReferenciaDirectusSlug = 'jardim_aquarius'; // Fallback seguro
let todasCategorias = [];


// 1. Consulta de Todos os Bairros de SJC (Listagem no topo)
try {
    bairrosDirectus = await api.fetchAllBairros();
} catch (e) {
    console.error("ERRO [index]: Falha ao buscar bairros. Renderizando lista vazia.", e);
}

const bairrosSJC = bairrosDirectus.map(item => ({ 
    slug: item.slug_bairro, 
    nome: item.nome_bairro 
}));


// 2. Define o Bairro de Refer√™ncia (Jardim Aquarius)
try {
    const fetchedSlug = await api.fetchReferenciaBairroSlug();
    if (fetchedSlug) {
        bairroReferenciaDirectusSlug = fetchedSlug;
    }
} catch (e) {
    console.error("ERRO [index]: Falha ao buscar bairro de refer√™ncia. Usando 'jardim_aquarius'.", e);
}

// Redefine as vari√°veis de URL de refer√™ncia (Jardim Aquarius)
const primeiroBairroUrlSlug = api.toUrlSlug(bairroReferenciaDirectusSlug);
const primeiroBairroDirectusSlug = bairroReferenciaDirectusSlug;


// 3. Consulta de Todas as Categorias Locais (N√≠veis 1, 2 e 3)
try {
    todasCategorias = await api.fetchAllCategorias();
} catch (e) {
    console.error("ERRO [index]: Falha ao buscar categorias. Renderizando listas vazias.", e);
}


// 4. Separa√ß√£o das categorias por n√≠vel (L√≥gica mantida)
const countSlashes = (slug: string) => (slug.match(/\//g) || []).length;

const nv1Categorias = todasCategorias.filter(c => countSlashes(c.full_slug_nicho) === 0);
const nv2Categorias = todasCategorias.filter(c => countSlashes(c.full_slug_nicho) === 1);
const nv3Categorias = todasCategorias.filter(c => countSlashes(c.full_slug_nicho) >= 2);

// Estilos de layout mantidos
const gridStyle = 'list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.75rem;';
const cardStyle = 'display: block; background:#fff; border-radius:0.75rem; border:1px solid #ddd; padding:0.75rem 1rem; height: 100%; transition: background 0.2s; cursor: pointer; text-decoration: none;';
const sectionDividerStyle = 'border: 0; border-top: 1px solid #eee; margin: 3rem 0;';
const bairroTagStyle = 'display: inline-block; background: #fff; border: 1px solid #ddd; border-radius: 0.5rem; padding: 0.5rem 0.75rem; margin: 0 0.5rem 0.5rem 0; text-decoration: none; color: #1f2937; transition: background 0.2s;';


const title = `Guia de Empresas e Servi√ßos em ${CITY_NAME} | ${SITE_DOMAIN}`;
const metaDescription = `Encontre as melhores empresas, com√©rcios e servi√ßos de ${CITY_NAME}. Guias por bairro e categoria.`;
---


<Layout title={title} description={metaDescription}>
    <div style="padding: 2rem 1rem; max-width: 1280px; margin: 0 auto;">

        {/* --- 1. CABE√áALHO --- */}
        <header style="margin-bottom: 3rem;">
            <h1 style="font-size: 2.5rem; font-weight: 800; color: #1f2937; margin: 0 0 0.5rem 0;">
                Tudo em {CITY_NAME}
            </h1>
            <p style="font-size: 1.25rem; color: #555; margin: 0;">
                O guia de empresas e servi√ßos mais completo para encontrar o que voc√™ procura.
            </p>
        </header>
        
        {/* --- 2. LISTAGEM DE TODOS OS BAIRROS (POSI√á√ÉO RESTAURADA) --- */}
        <section style="margin-bottom: 3rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 1.5rem;">
                Encontre o seu Bairro (Diret√≥rio Completo)
            </h2>
            {bairrosSJC.length > 0 ? (
                <div style="font-size: 1rem; display: flex; flex-wrap: wrap;">
                    {bairrosSJC.map((bairro) => (
                        <a 
                            href={`/${toUrlSlug(bairro.slug)}`} 
                            style={bairroTagStyle}
                        >
                            {bairro.nome}
                        </a>
                    ))}
                </div>
            ) : (
                <p style="color: red;">Nenhum bairro encontrado.</p>
            )}
        </section>

        <hr style={sectionDividerStyle} />

        {/* --- 3. CATEGORIAS N√çVEL 1 (PRINCIPAIS) --- */}
        <section style="margin-bottom: 3rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem; font-weight: bold; color: #3b82f6;">
                üìç Busca por Categoria (no Bairro {formatSlug(primeiroBairroDirectusSlug)})
            </h2>
            
            <ul style="list-style:none; padding:0; margin:0; display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:0.75rem;">
                {nv1Categorias.length > 0 ? (
                    nv1Categorias.map((categoria) => (
                        <li>
                            <a href={`/${primeiroBairroUrlSlug}/${categoria.slug_nicho}`} style="text-decoration: none;">
                                <article style={cardStyle}>
                                    <h3 style="margin:0; font-size:1.05rem; color:#005bbb; font-weight: 600;">
                                        {categoria.nome_nicho}
                                    </h3>
                                    <p style="margin:0; font-size:0.85rem; color:#666;">
                                        Clique para ver em {formatSlug(primeiroBairroDirectusSlug)}
                                    </p>
                                </article>
                            </a>
                        </li>
                    ))
                ) : (
                    <p style="color: red;">Nenhuma categoria de N√≠vel 1 encontrada.</p>
                )}
            </ul>
        </section>

        <hr style={sectionDividerStyle} />

        {/* --- 4. CATEGORIAS N√çVEL 2 (SUBDIVIS√ïES) --- */}
        <section style="margin-bottom: 3rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 1.5rem;">
                Subcategorias (Nv2)
            </h2>
            {nv2Categorias.length > 0 ? (
                <div style={gridStyle}>
                    {nv2Categorias.map((categoria) => (
                        <a 
                            href={`/${primeiroBairroUrlSlug}/${categoria.full_slug_nicho}`} 
                            style={cardStyle}
                        >
                            <h3 style="margin: 0 0 0.25rem 0; font-size: 1.1rem; font-weight: 700; color: #1f2937;">
                                {categoria.nome_nicho}
                            </h3>
                            <p style="margin: 0; font-size: 0.85rem; color: #4b5563;">
                                Ver {formatSlug(primeiroBairroDirectusSlug)}
                            </p>
                        </a>
                    ))}
                </div>
            ) : (
                <p style="color: #999;">Nenhuma subcategoria (N√≠vel 2) encontrada.</p>
            )}
        </section>

        <hr style={sectionDividerStyle} />

        {/* --- 5. CATEGORIAS N√çVEL 3 (SERVI√áOS ESPEC√çFICOS) --- */}
        <section style="margin-bottom: 3rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 1.5rem;">
                Servi√ßos Espec√≠ficos (Nv3)
            </h2>
            {nv3Categorias.length > 0 ? (
                <div style={gridStyle}>
                    {nv3Categorias.map((categoria) => (
                        <a 
                            href={`/${primeiroBairroUrlSlug}/${categoria.full_slug_nicho}`} 
                            style={cardStyle}
                        >
                            <h3 style="margin: 0 0 0.25rem 0; font-size: 1.1rem; font-weight: 700; color: #1f2937;">
                                {categoria.nome_nicho}
                            </h3>
                            <p style="margin: 0; font-size: 0.85rem; color: #4b5563;">
                                Ver {formatSlug(primeiroBairroDirectusSlug)}
                            </p>
                        </a>
                    ))}
                </div>
            ) : (
                <p style="color: #999;">Nenhum servi√ßo espec√≠fico (N√≠vel 3) encontrado.</p>
            )}
        </section>

    </div>
</Layout>