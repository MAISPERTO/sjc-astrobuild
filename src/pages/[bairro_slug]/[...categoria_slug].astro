---
// CORRE√á√ÉO: Caminho do Layout para rotas profundas
import Layout from '../../layouts/Layout.astro'; 
export const prerender = false; 

// Defini√ß√µes globais
const DIRECTUS_API_URL = 'https://directus.maisperto.com.br/items/'; 
const ID_SJC = 3; 
const CITY_NAME = "S√£o Jos√© dos Campos";
const SITE_NAME = "SJC.MP";
const DIRECTUS_ASSETS_URL = 'https://directus.maisperto.com.br/assets/';

// FUN√á√ïES DE SLUG
const toUrlSlug = (slug) => slug.replace(/_/g, '-');
const toDirectusSlug = (slug) => slug.replace(/-/g, '_');
const formatSlug = (slug) => slug.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());


// ----------------------------------------------------
// 1. FUN√á√ïES DE BUSCA 
// ----------------------------------------------------

const getNamesAndDescriptions = async (directusBairroSlug, directusCategorySlug) => {
    const [bairroResponse, categoriaResponse] = await Promise.all([
        fetch(`${DIRECTUS_API_URL}mp_bairros?filter[cidade_relacionada][id]=${ID_SJC}&filter[slug_bairro][_eq]=${directusBairroSlug}&fields=nome_bairro`),
        fetch(`${DIRECTUS_API_URL}mp_categorias_locais?filter[full_slug_nicho][_eq]=${directusCategorySlug}&fields=nome_nicho,descricao_curta_nicho,descricao_completa_nicho`)
    ]);

    const [bairroData, categoriaData] = await Promise.all([
        bairroResponse.json(), 
        categoriaResponse.json()
    ]);

    const nomeBairro = bairroData.data && bairroData.data.length > 0 
        ? bairroData.data[0].nome_bairro 
        : formatSlug(directusBairroSlug); 

    const categoria = categoriaData.data && categoriaData.data.length > 0
        ? categoriaData.data[0]
        : null;

    if (!categoria) {
        return { nomeBairro, nomeCategoria: formatSlug(directusCategorySlug), curta: 'Encontre o que voc√™ procura no bairro.', error: true }; 
    }
        
    return { 
        nomeBairro, 
        nomeCategoria: categoria.nome_nicho || formatSlug(directusCategorySlug),
        curta: categoria.descricao_curta_nicho || `Encontre os melhores servi√ßos e empresas de ${categoria.nome_nicho} no bairro ${nomeBairro} em ${CITY_NAME}.`,
        error: false
    };
};


const getLocaisDaCategoria = async (bairroSlug, categoriaSlug) => {
    try {
        const params = new URLSearchParams({
            'filter[bairro_relacionado][slug_bairro][_eq]': bairroSlug,
            'filter[categorias_locais][mp_categorias_locais_id][full_slug_nicho][_eq]': categoriaSlug,
            'filter[ativo][_eq]': 'true',
            'fields': 'slug_local,nome_local,descricao_local,imagem_principal.filename_disk', 
            'limit': '-1'
        });

        const response = await fetch(`${DIRECTUS_API_URL}mp_locais?${params.toString()}`);
        if (!response.ok) {
            console.error(`Falha ao buscar locais. Status: ${response.status}`);
            return [];
        }
        const data = await response.json();
        return data.data || [];
    } catch (error) {
        console.error('ERRO na busca de Locais:', error);
        return [];
    }
};


// ----------------------------------------------------
// 2. Execu√ß√£o do c√≥digo com 'await'
// ----------------------------------------------------

const { 'bairro_slug': bairro_slug, 'categoria_slug': categoria_slug_param } = Astro.params;

const directusCategorySlug = Array.isArray(categoria_slug_param) 
    ? categoria_slug_param.join('/') 
    : categoria_slug_param; 
    
const directusBairroSlug = toDirectusSlug(bairro_slug);

// Busca de dados
const { nomeBairro, nomeCategoria, curta, error } = await getNamesAndDescriptions(directusBairroSlug, directusCategorySlug);

// 404 se a categoria n√£o existir
if (error) {
    return Astro.redirect('/404');
}

const locais = await getLocaisDaCategoria(directusBairroSlug, directusCategorySlug);


// --- Vari√°veis para o Patroc√≠nio ---
const PATROCINIO_URL = 'https://maisperto.com.br/anunciar/'; // URL CORRIGIDA
const tituloPatrocinio = `Patrocinador Destaque`; 
const destaquePatrocinio = `Seja o patrocinador oficial desta p√°gina de ${nomeCategoria} em ${nomeBairro}`; // Texto Din√¢mico
const descricaoPatrocinioLonga = `Este espa√ßo 300x600 √© reservado para destacar, em primeira posi√ß√£o, a sua marca de ${nomeCategoria} em toda a cidade de ${CITY_NAME}. Aqui voc√™ pode exibir um criativo no formato 300x600, atrair clientes do nicho ${nomeCategoria} e ainda combinar com campanhas externas.`;
const contatoPatrocinio = `Entre em contato com a equipe MAISPERTO para reservar este espa√ßo e ativar sua campanha combinando an√∫ncios locais, TikTags e blocos com banners 300x600 alinhados ao seu objetivo de vendas.`;

const title = `${nomeCategoria} em ${nomeBairro} | ${SITE_NAME}`;
const metaDescription = curta; 

// ...

---

<Layout title={title} description={metaDescription}>
    
    <div style="padding: 2rem 1rem; max-width: 1280px; margin: 0 auto;">

        <header style="margin-bottom: 2rem;">
            <nav style="margin-bottom: 0.5rem; font-size: 0.85rem; color: #777; display:flex; align-items:center; flex-wrap:wrap; gap:4px;">
                <a href="/" style="color: #555; text-decoration: none;">{CITY_NAME}</a>
                <span style="margin: 0 0.25rem;">‚Ä∫</span>
                <a href={`/${bairro_slug}/`} style="color: #555; text-decoration: none;">{nomeBairro}</a>
                <span style="margin: 0 0.25rem;">‚Ä∫</span>
                <span style="font-weight: 600; color: #333;">{nomeCategoria}</span>
            </nav>
        
            <h1 style="margin: 0 0 0.5rem 0; font-size: 2.2rem; font-weight: 800; color: #1f2937;">
                {nomeCategoria} em {nomeBairro}
            </h1>
            <p style="margin: 0; font-size: 1.1rem; color: #555;">
                {curta}
            </p>
        </header>

        <section style="margin-bottom: 3rem;">
            
          {/* üõë CARD DE PATROC√çNIO FIXO RESPONSIVO */}
            <div class="card-grid">
                <article class="patrocinio-card">
                    
                    {/* SE√á√ÉO 1: M√çDIA (Adsense) */}
                    <div class="patrocinio-media">
                        <div style="width: 100%; height: 100%; background: #e9ffe9; display: flex; align-items: center; justify-content: center; text-align: center;">
                            {/* SEU C√ìDIGO ADSENSE AQUI */}
                            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3803893738575618"
                                crossorigin="anonymous"></script>
                            <ins class="adsbygoogle"
                                style="display:block; max-width: 300px; max-height: 600px;"
                                data-ad-client="ca-pub-3803893738575618"
                                data-ad-slot="2377366455"
                                data-ad-format="auto"
                                data-full-width-responsive="true"></ins>
                            <script>
                                (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div>
                    </div>
                    
                    {/* SE√á√ÉO 2: CONTE√öDO E CTA - AGORA DIN√ÇMICO */}
                    <div class="patrocinio-content">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.3rem; font-weight: 700; color: #28a745;">
                            {tituloPatrocinio}
                        </h3>
                        <p style="margin: 0 0 0.5rem 0; font-size: 1.1rem; color: #1f2937; font-weight: 600;">
                            {destaquePatrocinio}
                        </p>
                        <p style="margin: 0 0 1rem 0; font-size: 0.95rem; color: #4b5563;">
                            {descricaoPatrocinioLonga}
                        </p>
                        <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">
                            {contatoPatrocinio}
                        </p>

                        <a href={PATROCINIO_URL} class="ad-cta-button" target="_blank" rel="noopener noreferrer">
                            Quero anunciar nesta p√°gina
                        </a>
                    </div>
                </article>

                {/* LOCAIS CADASTRADOS (SEMPRE OCUPAM AS COLUNAS RESTANTES) */}
                {/* ... (restante do loop de locais) ... */}

                {locais.length > 0 && locais.map((local) => (
                    <a  
                        href={`/${bairro_slug}/${toUrlSlug(local.slug_local)}`} 
                        class="local-card-link"
                    >
                        <article class="local-card">
                            
                            {local.imagem_principal?.filename_disk ? (
                                <img 
                                    src={`${DIRECTUS_ASSETS_URL}${local.imagem_principal.filename_disk}?width=400&height=200&fit=cover`} 
                                    alt={`Imagem de ${local.nome_local}`} 
                                    class="local-card-image"
                                />
                            ) : (
                                <div class="local-card-placeholder">
                                    Sem Imagem
                                </div>
                            )}

                            <div style="padding: 1rem;">
                                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.3rem; font-weight: 700; color: #1f2937;">
                                    {local.nome_local}
                                </h3>
                                <p style="margin: 0; font-size: 0.95rem; color: #4b5563;">
                                    {local.descricao_local || 'Nenhuma descri√ß√£o dispon√≠vel.'}
                                </p>
                            </div>
                        </article>
                    </a>
                ))}

            </div>

            {locais.length === 0 && (
                <div style="padding: 2rem; border: 1px dashed #fcd34d; border-radius: 8px; background: #fffbeb; text-align: center; margin-top: 1.5rem;">
                    <p style="color: #d97706; font-weight: 600; font-size: 1.1rem;">
                        Nenhum neg√≥cio ativo encontrado para "{nomeCategoria}" em "{nomeBairro}".
                    </p>
                </div>
            )}
        </section>

    </div>
</Layout>

<style>
    /* CORRE√á√ÉO FINAL: Aplica box-sizing para que padding e border sejam inclu√≠dos DENTRO da largura de 300px */
    .patrocinio-card, .local-card, 
    .patrocinio-card *, .local-card *, 
    .local-card-link, .ad-cta-button {
        box-sizing: border-box; 
    }

    /* ------------------------------------------- */
    /* ESTILOS DA SE√á√ÉO E DO GRID PRINCIPAL */
    /* ------------------------------------------- */
    .card-grid {
        display: grid;
        /* Garante que o grid crie colunas de 300px */
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    /* ------------------------------------------- */
    /* CARD BASE (Patroc√≠nio e Locais) */
    /* ------------------------------------------- */
    .patrocinio-card, .local-card {
        border-radius: 0.75rem;
        overflow: hidden;
        background: #fff;
        height: 100%;
        
        /* 1. Garante a altura m√≠nima de 600px para o card principal */
        min-height: 600px;
        
        /* 2. Layout vertical por padr√£o (Mobile) */
        display: flex;
        flex-direction: column; 
    }

    /* Estilos espec√≠ficos de borda/sombra */
    .patrocinio-card {
        border: 2px solid #28a745;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
    }
    .local-card {
        border: 1px solid #eee;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
    }

    /* ------------------------------------------- */
    /* SUBSE√á√ïES DENTRO DO CARD */
    /* ------------------------------------------- */
    .patrocinio-media, .patrocinio-content {
        /* Permite que o conte√∫do e a m√≠dia ocupem o espa√ßo necess√°rio */
        flex-grow: 1;
        min-height: 300px; /* Garante que a m√≠dia e o conte√∫do tenham 300px de altura m√≠nima cada no celular */
    }

    .patrocinio-media {
        /* Estiliza o cont√™iner do Adsense (M√≠dia) */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .patrocinio-content {
        /* Conte√∫do (baixo no mobile) */
        padding: 1rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Empurra o bot√£o para baixo */
    }

    .ad-cta-button {
        display: block; 
        padding: 0.6rem; 
        text-align: center; 
        background: #28a745; 
        color: white; 
        text-decoration: none; 
        border-radius: 0.5rem; 
        font-weight: 600;
        margin-top: auto; /* Garante que o bot√£o v√° para o final do bloco */
    }


    /* ------------------------------------------- */
    /* MEDIA QUERY: Desktop/Tablet (Grade de 2 Colunas) */
    /* ------------------------------------------- */
    @media (min-width: 640px) {
        .patrocinio-card {
            /* Desktop: Layout horizontal (M√≠dia | Conte√∫do) */
            flex-direction: row; 
            /* Define a largura m√°xima total do card no desktop (300px + 300px) */
            max-width: 600px;
            /* Remove a altura m√≠nima no container principal para permitir o crescimento do conte√∫do */
            min-height: auto; 
            margin: 0 auto 1.5rem; /* Centraliza o card na grade */
        }
        
        .patrocinio-media, .patrocinio-content {
            /* Definimos 300px fixo para garantir a propor√ß√£o 300x600 */
            min-width: 300px;
            max-width: 300px; 
            min-height: 600px; /* Garante que ambos tenham 600px de altura */
            flex-basis: 300px; /* Ajuda o flex a entender a largura base */
            flex-shrink: 0; /* Impede que o browser tente reduzir essa largura */
        }

        .patrocinio-media {
            border-right: 2px solid #28a745; /* Linha de separa√ß√£o */
        }
    }

    /* ------------------------------------------- */
    /* ESTILOS DOS CARDS NORMAIS (EMPRESAS) */
    /* ------------------------------------------- */
    .local-card-link {
        text-decoration: none;
        display: block;
        height: 100%;
    }

    .local-card {
        /* ... existente ... */
    }

    .local-card-image {
        width: 100%; 
        height: 300px; 
        object-fit: cover;
    }

    .local-card-placeholder {
        width: 100%; 
        height: 300px; 
        background: #f0f0f0; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        color: #aaa; 
        font-size: 0.9rem;
    }
</style>